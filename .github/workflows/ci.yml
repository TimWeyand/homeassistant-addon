name: CI-release

on: [push, pull_request, workflow_dispatch]

jobs:
  variables:
    runs-on: ubuntu-latest
    outputs:
      ARCH_LIST: ${{ env.ARCH_LIST }}
    steps:
      - uses: actions/checkout@v3

      - name: Determine architectures
        id: determine_arch
        run: |
          ARCH_LIST=$(jq -r -c '.arch' ./SMA_Battery_Controller/config.json)
          echo "Found the following arches: $ARCH_LIST"
          echo "ARCH_LIST=$ARCH_LIST" >> $GITHUB_ENV

  build:
    runs-on: ubuntu-latest
    needs: variables
    strategy:
      matrix:
        arch: ${{ fromJSON(needs.variables.outputs.ARCH_LIST) }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Docker login
        run: echo ${{ secrets.DOCKERHUB }} | docker login -u tweyand --password-stdin

      - name: Build SMA_Battery_Controller
        run: |
          # Copy the necessary files for the SMA_Battery_Controller
          cp -R SMA_Battery_Controller $(pwd)/SMA_Battery_Controller
          
          # Navigate into the SMA_Battery_Controller directory
          cd SMA_Battery_Controller
          
          # Build the Docker image for SMA_Battery_Controller
          docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7,linux/386 \
            --build-arg BUILD_ARCH=${{ matrix.arch }} \
            -t yourdockerhubusername/sma_battery_controller:${{ github.sha }} \
            --push .

      - name: Build comfoair2mqtt
        run: |
          # Copy the necessary files for comfoair2mqtt
          cp -R comfoair2mqtt $(pwd)/comfoair2mqtt

          # Navigate into the comfoair2mqtt directory
          cd comfoair2mqtt/docker  # Adjust path as necessary
          
          # Build the Docker image for comfoair2mqtt
          docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7,linux/386 \
            --build-arg BUILD_ARCH=${{ matrix.arch }} \
            -t yourdockerhubusername/comfoair2mqtt:${{ github.sha }} \
            --push .
